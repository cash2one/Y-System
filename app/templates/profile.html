{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}{% if current_user.id == user.id %}研修档案{% else %}{{ user.name }}的档案{% endif %}{% endblock %}

{% block customized_styles %}
{{ super() }}
{% include '_style_profile.html' %}
{% endblock %}

{% block page_masthead %}
<div class="ui text container">
    {{ macros.message_widget() }}
    <h1 class="ui inverted header"><i class="archive icon"></i>{% if current_user.id == user.id %}研修档案{% else %}{{ user.name }}的档案{% endif %}</h1>
    <div class="ui inverted divided horizontal list">
        <div class="item">
            <div class="content">
                <div class="header">用户权限</div>
                <div class="description">{{ user.role.name }}</div>
            </div>
        </div>
        <div class="item">
            <div class="content">
                <div class="header">VB班</div>
                <div class="description">{% if user.vb_course %}{{ user.vb_course.name }}{% else %}无{% endif %}</div>
            </div>
        </div>
        {% if user.can('预约Y-GRE课程') %}
        <div class="item">
            <div class="content">
                <div class="header">Y-GRE班</div>
                <div class="description">{% if user.y_gre_course %}{{ user.y_gre_course.name }}{% else %}无{% endif %}</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block page_content %}
<div class="ui vertical stripe segment">
    {% if show_profile_progress %}
    <div id="page-loading-progress" class="ui top attached blue inverted progress">
        <div class="bar"></div>
    </div>
    {% endif %}
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <div class="ui three item labeled icon pointing menu">
                    <a class="item loading-trigger" href="#"><i class="user icon"></i>基本信息</a>
                    <a class="item {% if show_profile_progress %}active {% endif %}loading-trigger" href="{{ url_for('main.profile_progress', id=user.id) }}"><i class="flag icon"></i>研修进度</a>
                    <a class="item {% if show_profile_bookings %}active {% endif %}loading-trigger" href="{{ url_for('main.profile_bookings', id=user.id) }}"><i class="checked calendar icon"></i>预约记录</a>
                </div>
                {% if show_profile_progress %}
                <h3 class="ui header">
                    <i class="flag icon"></i>
                    <div class="content">
                        研修进度
                        <div class="sub header">VB完成 <span id="vb-progress">0</span>%{% if user.can('预约Y-GRE课程') %} &middot; Y-GRE完成 <span id="y-gre-progress">0</span>%{% endif %}</div>
                    </div>
                </h3>
                <h4 id="last-vb-punch" class="ui header disabled">VB进度：<span>尚未开始</span></h4>
                <div class="ui vb progress disabled">
                    <div class="bar">
                        <div class="progress"></div>
                    </div>
                </div>
                <table class="ui very basic selectable celled table">
                    <thead>
                        <tr>
                            <th>课程</th>
                            <th>内容</th>
                            <th>作业</th>
                            <th>考试</th>
                        </tr>
                    </thead>
                    <tbody id="vb-lessons"></tbody>
                    {# <tbody>
                        {% for lesson in vb_lessons %}
                        <tr{% if lesson.sections.count() > 1 %} class="top aligned"{% endif %}>
                            <td class="single line">{{ lesson.name }}</td>

                            {% with sections = lesson.sections %}<td{% if sections.count() < 3 %} class="single line"{% endif %}>{% if sections.count() %}<div class="ui labels">{% for section in sections %}{% if user.punched(section) %}<div class="ui {% if section.id == user.last_punch.section.id %}orange{% else %}green{% endif %} label popup-trigger" data-variation="inverted"><i class="{% if section.id == user.last_punch.section.id %}play{% else %}check{% endif %} icon"></i>{{ section.name }}</div><div class="ui popup popup-content">{{ moment(user.punched_at(section)).fromNow() }}<br />{{ moment(user.punched_at(section)).format('YYYY-M-D H:mm:ss') }}</div>{% else %}<div class="ui label">{{ section.name }}</div>{% endif %}{% endfor %}</div>{% else %}无{% endif %}</td>{% endwith %}

                            {% with assignments = lesson.assignments %}<td{% if assignments.count() < 3 %} class="single line"{% endif %}>{% if assignments.count() %}<div class="ui labels">{% for assignment in assignments %}{% if user.submitted(assignment) %}<div class="ui green label popup-trigger" data-variation="inverted"><i class="check icon"></i>{{ assignment.name }}<div class="detail">{{ user.submitted(assignment).grade.name }}</div></div><div class="ui popup popup-content">{{ moment(user.submitted(assignment).modified_at).fromNow() }}<br />{{ moment(user.submitted(assignment).modified_at).format('YYYY-M-D H:mm:ss') }}</div>{% else %}<div class="ui label">{{ assignment.name }}</div>{% endif %}{% endfor %}</div>{% else %}无{% endif %}</td>{% endwith %}

                            {% with tests = lesson.tests %}<td{% if tests.count() < 3 %} class="single line"{% endif %}>{% if tests.count() %}<div class="ui labels">{% for test in tests %}{% if user.taken_vb(test) %}<div class="ui green label popup-trigger" data-variation="inverted"><i class="check icon"></i>{{ test.name }}<div class="detail">{{ user.taken_vb(test).score_alias }}</div></div><div class="ui popup popup-content">{{ moment(user.taken_vb(test).modified_at).fromNow() }}<br />{{ moment(user.taken_vb(test).modified_at).format('YYYY-M-D H:mm:ss') }}</div>{% else %}<div class="ui label">{{ test.name }}</div>{% endif %}{% endfor %}</div>{% else %}无{% endif %}</td>{% endwith %}
                        </tr>
                        {% endfor %}
                    </tbody> #}
                </table>
                {% if user.can('预约Y-GRE课程') %}
                <h4 id="last-y-gre-punch" class="ui header disabled">Y-GRE进度：<span>尚未开始</span></h4>
                <div class="ui y-gre progress disabled">
                    <div class="bar">
                        <div class="progress"></div>
                    </div>
                </div>
                <table class="ui very basic selectable celled table">
                    <thead>
                        <tr>
                            <th>课程</th>
                            <th>内容</th>
                            <th>考试</th>
                        </tr>
                    </thead>
                    <tbody id="y-gre-lessons"></tbody>
                    {# <tbody>
                        {% for lesson in y_gre_lessons %}
                        <tr>
                            <td class="single line">{{ lesson.name }}</td>
                            {% with sections = lesson.sections %}<td{% if sections.count() < 3 %} class="single line"{% endif %}>{% if sections.count() %}<div class="ui labels">{% for section in sections %}{% if user.punched(section) %}<div class="ui {% if section.id == user.last_punch.section.id and section.name != '9th' %}orange{% else %}green{% endif %} label popup-trigger" data-variation="inverted"><i class="{% if section.id == user.last_punch.section.id and section.name != '9th' %}play{% else %}check{% endif %} icon"></i>{{ section.name }}</div><div class="ui popup popup-content">{{ moment(user.punched_at(section)).fromNow() }}<br />{{ moment(user.punched_at(section)).format('YYYY-M-D H:mm:ss') }}</div>{% else %}<div class="ui label">{{ section.name }}</div>{% endif %}{% endfor %}</div>{% else %}无{% endif %}</td>{% endwith %}
                            {% with tests = lesson.tests %}<td{% if tests.count() < 3 %} class="single line"{% endif %}>{% if tests.count() %}<div class="ui labels">{% for test in tests %}{% if user.taken_y_gre(test) %}<div class="ui green label popup-trigger" data-variation="inverted"><i class="check icon"></i>{{ test.name }}<div class="detail">{{ user.taken_y_gre(test).v_score_alias }}</div></div><div class="ui popup popup-content">{{ user.taken_y_gre(test).score_alias }}<br />{{ moment(user.taken_y_gre(test).modified_at).fromNow() }}<br />{{ moment(user.taken_y_gre(test).modified_at).format('YYYY-M-D H:mm:ss') }}</div>{% else %}<div class="ui label">{{ test.name }}</div>{% endif %}{% endfor %}</div>{% else %}无{% endif %}</td>{% endwith %}
                        </tr>
                        {% endfor %}
                    </tbody> #}
                </table>
                {% endif %}
                {% endif %}
                {% if show_profile_bookings %}
                <h3 class="ui header">
                    <i class="checked calendar icon"></i>
                    <div class="content">
                        预约记录
                        <div class="sub header">{{ user.valid_bookings.count() }} 个即将开始 &middot; {{ user.wait_bookings.count() }} 个排队中 &middot; 赴约 {{ user.keep_bookings.count() }} 次 &middot; 爽约 {{ user.miss_bookings.count() }} 次 &middot; 取消 {{ user.cancel_bookings.count() }} 次 &middot; 迟到 {{ user.late_bookings.count() }} 次 &middot; 未预约到场 {{ user.walk_in_rentals.count() }} 次</div>
                    </div>
                </h3>
                <table class="ui very basic sortable selectable celled table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>时段</th>
                            <th>状态</th>
                            <th>预约状态</th>
                            <th>预约码</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>{{ moment(booking.schedule.date).format('YYYY-M-D ddd') }}</td>
                            <td>{{ booking.schedule.period.type.name }}</td>
                            <td>{% if booking.schedule.unstarted %}<div class="ui teal label">{{ booking.schedule.time_state }}</div>{% endif %}{% if booking.schedule.started %}<div class="ui red label">{{ booking.schedule.time_state }}</div>{% endif %}{% if booking.schedule.ended %}<div class="ui label">{{ booking.schedule.time_state }}</div>{% endif %}{{ moment(booking.schedule.period.start_time_utc).format('H:mm') }} - {{ moment(booking.schedule.period.end_time_utc).format('H:mm') }}</td>
                            <td>{% if booking.valid %}<i class="checked calendar icon"></i>{% endif %}{% if booking.waited %}<i class="wait icon"></i>{% endif %}{% if booking.canceled %}<i class="remove from calendar icon"></i>{% endif %}{% if booking.kept %}<i class="smile icon"></i>{% endif %}{% if booking.late %}<i class="meh icon"></i>{% endif %}{% if booking.missed %}<i class="frown icon"></i>{% endif %}{% if booking.invalid %}<i class="delete icon"></i>{% endif %}{{ booking.state.name }}{% if booking.waited %}<div class="ui teal circular label">{{ booking.queue_position }}</div>{% endif %}</td>
                            <td>{% if booking.valid %}<i id="booking-qr-code-click-{{ booking.user_id }}-{{ booking.schedule_id }}" class="large blue qrcode link icon"></i><div id="booking-qr-code-{{ booking.user_id }}-{{ booking.schedule_id }}" class="ui flowing popup top left transition hidden"><img class="ui small image" src="{{ qrcode(booking.token) }}"></div>{% else %}N/A{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if pagination %}{{ macros.pagination_widget(pagination, 'main.profile', id=user.id) }}{% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if announcements %}
<div class="ui vertical stripe segment">
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <h3 class="ui header"><i class="announcement icon"></i>通知</h3>
                <div class="ui divided items">
                    {% for announcement in announcements %}
                    <div class="item">
                        <div class="content">
                            <div class="header">{{ announcement.title }}</div>
                            {% if current_user.can('管理通知') %}
                            <div class="right floated">
                                <a class="ui circular icon button loading-trigger" href="{{ url_for('manage.retract_announcement', id=announcement.id, next=url_for('main.profile', id=user.id, page=pagination.page)) }}" data-content="撤回" data-position="top center" data-variation="inverted"><i class="undo icon"></i></a>
                                <a class="ui circular icon button loading-trigger" href="{{ url_for('manage.edit_announcement', id=announcement.id, next=url_for('main.profile', id=user.id, page=pagination.page)) }}" data-content="编辑" data-position="top center" data-variation="inverted"><i class="edit icon"></i></a>
                                {% endif %}
                            </div>
                            <div class="meta"><i class="send outline icon"></i>{{ moment(announcement.modified_at).fromNow() }}</div>
                            <div class="description">{{ announcement.body_html | safe }}</div>
                            <div class="extra">发布人：{{ announcement.modified_by.name }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.can('管理') %}
<div class="ui vertical stripe segment">
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <h3 class="ui header"><i class="user icon"></i>查询用户档案</h3>
                <div class="ui search">
                    <div class="ui left icon input">
                        <input class="prompt" type="text" placeholder="姓名/邮箱">
                        <i class="user icon"></i>
                    </div>
                    <div class="results"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block customized_scripts %}
{{ super() }}
{% if show_profile_progress %}<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/countup.js/{{ Version.CountUp }}/countUp.min.js"></script>{% endif %}
{% if show_profile_bookings %}<script type="text/javascript" src="{{ url_for('static', filename='assets/js/tablesort.js') }}"></script>{% endif %}
<script type="text/javascript">
$('.message .close')
    .on('click', function() {
        $(this)
            .closest('.message')
            .transition('fade')
        ;
    })
;

{% if show_profile_progress %}
// progress bar
$('#page-loading-progress').progress({
    total: {% if user.can('预约Y-GRE课程') %}2{% else %}1{% endif %},
    onSuccess: function() {
        $('#page-loading-progress').fadeOut(1000, function() {
            $('#page-loading-progress').remove();
        });
    }
});

// count up settings
var countUpOptions = {
    useEasing: true,
    useGrouping: true,
    separator: ',',
    decimal: '.',
    prefix: '',
    suffix: ''
};

// VB progress
var VBProgressCountUp = new CountUp('vb-progress', 0, 0, 0, 2.5, countUpOptions);
var progressVBurl = '//' + window.location.hostname + ':' + window.location.port + '/profile/{{ user.id }}/progress/vb';
$.getJSON(progressVBurl, function(data) {
    if (data.progress > 0) {
        VBProgressCountUp.update(data.progress);
        $('#last-vb-punch').removeClass('disabled');
        $('#last-vb-punch span').text(data.last_punch.alias);
        $('.ui.vb.progress').removeClass('disabled').addClass('blue').progress({ percent: data.progress });
    };
    for (var i in data.lessons) {
        $('#vb-lessons').append(
            $('<tr>')
                .attr('id', 'vb-lessons-' + i)
                .append(
                    $('<td>')
                        .addClass('single line')
                        .text(data.lessons[i].name)
                )
                .append(
                    $('<td>').attr('id', 'vb-lessons-' + i + '-sections')
                )
                .append(
                    $('<td>').attr('id', 'vb-lessons-' + i + '-assignments')
                )
                .append(
                    $('<td>').attr('id', 'vb-lessons-' + i + '-tests')
                )
        );
        if (data.lessons[i].sections.length > 1) {
            $('#vb-lessons-' + i).addClass('top aligned');
        };
        if (data.lessons[i].sections.length < 3) {
            $('#vb-lessons-' + i + '-sections').addClass('single line');
        };
        if (data.lessons[i].sections.length > 0) {
            $('#vb-lessons-' + i + '-sections').append(
                $('<div>').addClass('ui labels')
            );
            for (var x in data.lessons[i].sections) {
                $('#vb-lessons-' + i + '-sections .ui.labels').append(
                    $('<div>')
                        .addClass('ui label')
                        .text(data.lessons[i].sections[x].name)
                );
            };
        } else {
            $('#vb-lessons-' + i + '-sections').text('无');
        };
        if (data.lessons[i].assignments.length < 3) {
            $('#vb-lessons-' + i + '-assignments').addClass('single line');
        };
        if (data.lessons[i].assignments.length > 0) {
            $('#vb-lessons-' + i + '-assignments').append(
                $('<div>').addClass('ui labels')
            );
            for (var y in data.lessons[i].assignments) {
                $('#vb-lessons-' + i + '-assignments .ui.labels').append(
                    $('<div>')
                        .addClass('ui label')
                        .text(data.lessons[i].assignments[y].name)
                );
            };
        } else {
            $('#vb-lessons-' + i + '-assignments').text('无');
        };
        if (data.lessons[i].tests.length < 3) {
            $('#vb-lessons-' + i + '-tests').addClass('single line');
        };
        if (data.lessons[i].tests.length > 0) {
            $('#vb-lessons-' + i + '-tests').append(
                $('<div>').addClass('ui labels')
            );
            for (var z in data.lessons[i].tests) {
                $('#vb-lessons-' + i + '-tests .ui.labels').append(
                    $('<div>')
                        .addClass('ui label')
                        .text(data.lessons[i].tests[z].name)
                );
            };
        } else {
            $('#vb-lessons-' + i + '-tests').text('无');
        };
    };
    $('#page-loading-progress').progress('increment');
});

{% if user.can('预约Y-GRE课程') %}
// Y-GRE progress
var YGREProgressCountUp = new CountUp('y-gre-progress', 0, 0, 0, 2.5, countUpOptions);
var progressYGREurl = '//' + window.location.hostname + ':' + window.location.port + '/profile/{{ user.id }}/progress/y-gre';
$.getJSON(progressYGREurl, function(data) {
    if (data.progress > 0) {
        YGREProgressCountUp.update(data.progress);
        $('#last-y-gre-punch').removeClass('disabled');
        $('#last-y-gre-punch span').text(data.last_punch.alias);
        $('.ui.y-gre.progress').removeClass('disabled').addClass('teal').progress({ percent: data.progress });
    };
    $('.ui.y-gre.progress').progress({ percent: data.progress });
    for (var i in data.lessons) {
        $('#y-gre-lessons').append(
            $('<tr>')
                .attr('id', 'y-gre-lessons-' + i)
                .append(
                    $('<td>')
                        .addClass('single line')
                        .text(data.lessons[i].name)
                )
                .append(
                    $('<td>').attr('id', 'y-gre-lessons-' + i + '-sections')
                )
                .append(
                    $('<td>').attr('id', 'y-gre-lessons-' + i + '-tests')
                )
        );
        if (data.lessons[i].sections.length > 1) {
            $('#y-gre-lessons-' + i).addClass('top aligned');
        };
        if (data.lessons[i].sections.length < 3) {
            $('#y-gre-lessons-' + i + '-sections').addClass('single line');
        };
        if (data.lessons[i].sections.length > 0) {
            $('#y-gre-lessons-' + i + '-sections').append(
                $('<div>').addClass('ui labels')
            );
            for (var x in data.lessons[i].sections) {
                $('#y-gre-lessons-' + i + '-sections .ui.labels').append(
                    $('<div>')
                        .addClass('ui label')
                        .text(data.lessons[i].sections[x].name)
                );
            };
        } else {
            $('#y-gre-lessons-' + i + '-sections').text('无');
        };
        if (data.lessons[i].tests.length < 3) {
            $('#y-gre-lessons-' + i + '-tests').addClass('single line');
        };
        if (data.lessons[i].tests.length > 0) {
            $('#y-gre-lessons-' + i + '-tests').append(
                $('<div>').addClass('ui labels')
            );
            for (var y in data.lessons[i].tests) {
                $('#y-gre-lessons-' + i + '-tests .ui.labels').append(
                    $('<div>')
                        .addClass('ui label')
                        .text(data.lessons[i].tests[y].name)
                );
            };
        } else {
            $('#y-gre-lessons-' + i + '-tests').text('无');
        };
    };
    $('#page-loading-progress').progress('increment');
});
{% endif %}
{% endif %}

{% if show_profile_bookings %}
$('.ui.sortable.table').tablesort();

{% for booking in bookings %}
$('#booking-qr-code-click-{{ booking.user_id }}-{{ booking.schedule_id }}')
    .popup({
        popup: $('#booking-qr-code-{{ booking.user_id }}-{{ booking.schedule_id }}'),
        on: 'click'
    })
;
{% endfor %}
{% endif %}

{% if announcements and current_user.can('管理通知') %}
$('.right.floated .ui.circular.icon.button').popup();
{% endif %}

{% if current_user.can('管理') %}
$('.ui.search')
    .search({
        apiSettings: {
            url: '//' + window.location.hostname + ':' + window.location.port + '/manage/search/user?keyword={query}'
        },
        showNoResults: false
    })
;
{% endif %}
</script>
{% endblock %}