{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}个人档案{% endblock %}

{% block customized_styles %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='assets/css/customize-profile.css') }}">
{% endblock %}

{% block page_masthead %}
<div class="ui text container">
    {{ macros.message_widget() }}
    <h1 class="ui inverted header"><i class="archive icon"></i> {{ user.name }}的档案</h1>
    <div class="ui inverted divided horizontal list">
        <div class="item">
            <div class="content">
                <div class="header">用户组</div>
                <div class="description">{{ user.role.name }}</div>
            </div>
        </div>
        <div class="item">
            <div class="content">
                <div class="header">VB班</div>
                <div class="description">
                    {% if user.vb_course %}
                    {{ user.vb_course.name }}
                    {% else %}
                    无
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="item">
            <div class="content">
                <div class="header">Y-GRE班</div>
                <div class="description">
                    {% if user.y_gre_course %}
                    {{ user.y_gre_course.name }}
                    {% else %}
                    无
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_content %}
<div class="ui vertical stripe stats segment">
    <div class="ui equal width stackable internally celled grid">
        <div class="center aligned row">
            <div class="column">
                <div class="ui statistic">
                    <div class="label">即将开始</div>
                    <div class="value">{{ user.valid_bookings.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
            <div class="column">
                <div class="ui statistic">
                    <div class="label">排队中</div>
                    <div class="value">{{ user.wait_bookings.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
            <div class="column">
                <div class="ui statistic">
                    <div class="label">赴约</div>
                    <div class="value">{{ user.keep_bookings.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
            <div class="column">
                <div class="ui statistic">
                    <div class="label">爽约</div>
                    <div class="value">{{ user.miss_bookings.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
            <div class="column">
                <div class="ui statistic">
                    <div class="label">取消</div>
                    <div class="value">{{ user.cancel_bookings.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
            <div class="column">
                <div class="ui statistic">
                    <div class="label">迟到</div>
                    <div class="value">{{ user.late_bookings.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
            <div class="column">
                <div class="ui statistic">
                    <div class="label">未预约到场</div>
                    <div class="value">{{ user.walk_in_rentals.count() }}</div>
                    <div class="label">次</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="ui vertical stripe segment">
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <h3 class="ui header"><i class="checked calendar icon"></i> 预约记录</h3>
                <table class="ui very basic sortable selectable celled table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>时段</th>
                            <th>状态</th>
                            <th>预约状态</th>
                            <th>预约码</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>{{ moment(booking.schedule.date).format('YYYY-M-D ddd') }}</td>
                            <td>{{ booking.schedule.period.type.name }}</td>
                            <td>
                                {% if booking.schedule.unstarted %}
                                <div class="ui teal label">{{ booking.schedule.time_state }}</div>
                                {% endif %}
                                {% if booking.schedule.started %}
                                <div class="ui red label">{{ booking.schedule.time_state }}</div>
                                {% endif %}
                                {% if booking.schedule.ended %}
                                <div class="ui label">{{ booking.schedule.time_state }}</div>
                                {% endif %}
                                {{ moment(booking.schedule.period.start_time_utc).format('H:mm') }} - {{ moment(booking.schedule.period.end_time_utc).format('H:mm') }}
                            </td>
                            <td>
                                {% if booking.valid %}
                                <i class="checked calendar icon"></i>
                                {% endif %}
                                {% if booking.waited %}
                                <i class="wait icon"></i>
                                {% endif %}
                                {% if booking.canceled %}
                                <i class="remove from calendar icon"></i>
                                {% endif %}
                                {% if booking.kept %}
                                <i class="smile icon"></i>
                                {% endif %}
                                {% if booking.late %}
                                <i class="meh icon"></i>
                                {% endif %}
                                {% if booking.missed %}
                                <i class="frown icon"></i>
                                {% endif %}
                                {% if booking.invalid %}
                                <i class="delete icon"></i>
                                {% endif %}
                                {{ booking.state.name }}
                                {% if booking.waited %}
                                <div class="ui teal circular label">{{ booking.queue_position }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if booking.valid %}
                                <a id="booking-qr-code-click-{{ booking.user_id }}-{{ booking.schedule_id }}"><i class="large qrcode icon"></i></a>
                                <div id="booking-qr-code-{{ booking.user_id }}-{{ booking.schedule_id }}" class="ui flowing popup top left transition hidden">
                                    <img class="ui small image" src="{{ qrcode(booking.booking_code) }}">
                                </div>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if pagination %}
                {{ macros.pagination_widget(pagination, 'main.profile') }}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="ui vertical stripe segment">
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <h3 class="ui header"><i class="flag icon"></i> 里程碑</h3>
                <table class="ui very basic sortable selectable celled table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>课程类型</th>
                            <th>课程进度</th>
                            <th>视频进度</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for punch in punches %}
                        <tr>
                            <td>
                                <div class="popup-trigger">{{ moment(punch.timestamp).fromNow() }}</div>
                                <div class="ui popup popup-content">{{ moment(punch.timestamp).format('YYYY-M-D H:mm:ss') }}</div>
                            </td>
                            <td>{{ punch.section.lesson.type.name }}</td>
                            <td>{{ punch.section.lesson.name }}</td>
                            <td>{{ punch.section.name }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% if announcements %}
<div class="ui vertical stripe segment">
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <h3 class="ui header"><i class="announcement icon"></i> 通知</h3>
                <div class="ui divided items">
                    {% for announcement in announcements %}
                    <div class="item">
                        <div class="content">
                            <div class="header">{{ announcement.title }}</div>
                            <div class="meta">发布人：{{ announcement.modified_by.name }}</div>
                            <div class="description">
                                <p>{{ announcement.body_html | safe }}</p>
                            </div>
                            <div class="extra">
                                <i class="notched circle loading icon"></i>
                                {{ moment(announcement.modified_at).fromNow() }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.can(Permission.MANAGE) %}
<div class="ui vertical stripe segment">
    <div class="ui middle aligned stackable grid container">
        <div class="row">
            <div class="column">
                <h3 class="ui header"><i class="user icon"></i> 查询用户档案</h3>
                <div class="ui search">
                    <div class="ui left icon input">
                        <input class="prompt" type="text" placeholder="姓名/邮箱">
                        <i class="user icon"></i>
                    </div>
                    <div class="results"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block customized_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='assets/js/tablesort.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/customize-profile.js') }}"></script>
<script>
    {% for booking in bookings %}
    $('#booking-qr-code-click-{{ booking.user_id }}-{{ booking.schedule_id }}')
        .popup({
            popup : $('#booking-qr-code-{{ booking.user_id }}-{{ booking.schedule_id }}'),
            on    : 'click'
        })
    ;
    {% endfor %}
</script>
{% endblock %}
